import streamlit as st
import pandas as pd
from data_bot import RealEstateBot

# 1. ุฅุนุฏุงุฏ ุงูุตูุญุฉ
st.set_page_config(page_title="ูุงุดู ุงูุจูุงูุงุช", layout="wide", page_icon="๐ต๏ธโโ๏ธ")

st.title("๐ต๏ธโโ๏ธ ูุงุดู ุงูุจูุงูุงุช ุงูุฎุงู (Raw Data Inspector)")
st.caption("ููุง ูุนุฑุถ ูู ุงูุฃุณุทุฑ ุงูุญููููุฉ ุงูููุฌูุฏุฉ ุฏุงุฎู ูููุงุช CSV ุงูุฎุงุตุฉ ุจู")

# 2. ุชุดุบูู ุงูุฑูุจูุช ูุชุญููู ุงูุจูุงูุงุช (ูุชู ูุฑุฉ ูุงุญุฏุฉ ููุญูุธ ูู ุงูุฐุงูุฑุฉ)
if 'bot' not in st.session_state:
    with st.spinner("๐ ุฌุงุฑู ูุฑุงุกุฉ ุงููููุงุช ูู Google Drive..."):
        st.session_state.bot = RealEstateBot()
    if not st.session_state.bot.df.empty:
        st.toast(f"ุชู ุชุญููู {len(st.session_state.bot.df)} ุตููุฉ ุจูุฌุงุญ!", icon="โ")

# ุงุฎุชุตุงุฑ ูููุตูู ููุฏุงุชุง
df = st.session_state.bot.df

# 3. ูุงุฌูุฉ ุงูุจุญุซ
col1, col2 = st.columns([3, 1])
with col1:
    # ูุฑุจุน ุงูุจุญุซ
    search_text = st.text_input("ุงูุชุจ ุงุณู ุงูุญู ููุจุญุซ ุนูู ูู ุงููููุงุช:", "ุงููููุง")
with col2:
    st.write("##")
    btn = st.button("ุฃุธูุฑ ุงูุตููุงุช ๐", type="primary", use_container_width=True)

# 4. ุนุฑุถ ุงููุชุงุฆุฌ
if btn:
    if df.empty:
        st.error("โ๏ธ ุงูุฑูุจูุช ูู ูุฌุฏ ุฃู ุจูุงูุงุช! ุชุฃูุฏ ุฃู data_bot.py ูุชุตู ุจุดูู ุตุญูุญ.")
    else:
        # ุนูููุฉ ุงูููุชุฑุฉ: ุงุจุญุซ ุนู ุงููุต ุงูููุชูุจ ุฏุงุฎู ุนููุฏ 'ุงูุญู'
        # (ูุณุชุฎุฏู str.contains ุนุดุงู ูู ูุชุจุช 'ุงููููุง' ูุทูุน ูู 'ุญู ุงููููุง')
        mask = df['ุงูุญู'].astype(str).str.contains(search_text, na=False)
        results = df[mask].copy()

        if results.empty:
            st.warning(f"โ ุจุญุซูุง ูู {len(df)} ุตููุฉ ููู ูุฌุฏ ุดูุฆุงู ูุทุงุจู: '{search_text}'")
            st.info("ุฌุฑุจ ูุชุงุจุฉ ุฌุฒุก ูู ุงูุงุณู ููุทุ ูุซูุงู: 'ุนุงุฑุถ' ุจุฏูุงู ูู 'ุงูุนุงุฑุถ'")
        else:
            # ุชุฑุชูุจ ุงูุฃุนูุฏุฉ ููุนุฑุถ (ุชุฃูุฏ ุฃู ุนููุฏ ุงููุตุฏุฑ ููุฌูุฏ)
            cols_to_show = ['ุงูุญู', 'ุงูุฎุทู', 'ุฑูู ุงููุทุนุฉ', 'ุงููุณุงุญุฉ', 'ุงูุณุนุฑ', 'ุณุนุฑ_ุงููุชุฑ', 'Source_File']
            
            # ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูุฃุนูุฏุฉ ูุจู ุนุฑุถูุง (ูุชุฌูุจ ุงูุฃุฎุทุงุก)
            final_cols = [c for c in cols_to_show if c in results.columns]
            
            st.success(f"โ ูุฌุฏูุง **{len(results)}** ุตููุฉ ุชุทุงุจู ุจุญุซู!")
            
            # ุนุฑุถ ุงูุฌุฏูู ูุงููุงู
            st.dataframe(
                results[final_cols], 
                use_container_width=True, 
                height=500  # ุงุฑุชูุงุน ุงูุฌุฏูู ุนุดุงู ุชุดูู ุฃุณุทุฑ ูุงุฌุฏ
            )
            
            # ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ ุนูู ุงููุชุงุฆุฌ ุงููุนุฑูุถุฉ ููุท
            st.markdown("---")
            c1, c2, c3 = st.columns(3)
            # ูุญุณุจ ุงููุชูุณุท ูู ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ ูุฏุงูู ุงูุญูู
            try:
                avg_meter = results['ุณุนุฑ_ุงููุชุฑ'].median() # ุงููุณูุท
                c1.metric("ูุชูุณุท ุณุนุฑ ุงููุชุฑ (ูู ุงูุฌุฏูู)", f"{avg_meter:,.0f} ุฑูุงู")
            except:
                pass
            
            c2.metric("ุฃุฑุฎุต ุตููุฉ", f"{results['ุณุนุฑ_ุงููุชุฑ'].min():,.0f} ุฑูุงู")
            c3.metric("ุฃุบูู ุตููุฉ", f"{results['ุณุนุฑ_ุงููุชุฑ'].max():,.0f} ุฑูุงู")
