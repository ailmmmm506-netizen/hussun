import streamlit as st
import pandas as pd
import data_bot

st.set_page_config(page_title="ุงููุทูุฑ ุงูุนูุงุฑู ุงูุฐูู", layout="wide")

# ุชุญููู ุงูุจูุงูุงุช
@st.cache_resource(show_spinner="ุฌุงุฑู ุงููุนุงูุฌุฉ...", ttl=3600)
def load_data(): return data_bot.RealEstateBot()

if 'bot' not in st.session_state: st.session_state.bot = load_data()
df = st.session_state.bot.df if hasattr(st.session_state.bot, 'df') else pd.DataFrame()

with st.sidebar:
    st.title("ุงููุงุฆูุฉ")
    # ุฃุถูุช ุฎูุงุฑุงู ุซุงูุซุงู ูููุญุต
    app_mode = st.radio("ุงููุถุน:", ["๐ต๏ธโโ๏ธ ูุญุต ุงูุชุตูููุงุช (Debug)", "๐ ุงูุฏุงุดุจูุฑุฏ", "๐๏ธ ุญุงุณุจุฉ ุงูุชูุงููู"])
    if st.button("๐ ุชุญุฏูุซ"):
        st.cache_data.clear()
        st.cache_resource.clear()
        st.rerun()

# ==========================================
# ๐ต๏ธโโ๏ธ ุตูุญุฉ ูุญุต ุงูุชุตูููุงุช (ุทูุจู ููุง)
# ==========================================
if app_mode == "๐ต๏ธโโ๏ธ ูุญุต ุงูุชุตูููุงุช (Debug)":
    st.title("๐ต๏ธโโ๏ธ ุงูุชุญูู ูู ุฏูุฉ ุชุตููู ุงูููุฏ")
    
    if df.empty:
        st.error("ูุง ุชูุฌุฏ ุจูุงูุงุช.")
        st.stop()

    # ููุงุชุฑ ููุจุญุซ
    c1, c2 = st.columns(2)
    with c1:
        dist_filter = st.selectbox("ุงุฎุชุฑ ุงูุญู:", ["ุงููู"] + sorted(df['ุงูุญู'].astype(str).unique()))
    with c2:
        search_term = st.text_input("ุจุญุซ ูู ุงูุชุตููู ุงูุฎุงู (ูุซูุงู: ุฑุงุณุ ุชุงููุ ุดูุฉ..):")

    # ุชุทุจูู ุงูููุงุชุฑ
    debug_df = df.copy()
    if dist_filter != "ุงููู":
        debug_df = debug_df[debug_df['ุงูุญู'] == dist_filter]
    
    if search_term:
        debug_df = debug_df[debug_df['ููุน_ุงูุนูุงุฑ_ุงูุฎุงู'].astype(str).str.contains(search_term, na=False)]

    # --- ุงูุฌุฏูู ุงูููู ---
    st.subheader(f"ุนุฑุถ ุงูุจูุงูุงุช ({len(debug_df)} ุนูุงุฑ)")
    
    # ุงุฎุชูุงุฑ ูุชุฑุชูุจ ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ
    cols_to_show = [
        'Source_File',       # ุงููุตุฏุฑ
        'ุงููุณุงุญุฉ',           # ูููู ุณุจุจ ุงูุชุตููู (ูุซูุงู ุฃูู ูู 200 = ุดูุฉ)
        'ููุน_ุงูุนูุงุฑ_ุงูุฎุงู', # ุชุตููู ุงูููู (ุฃูุช ุทูุจุช ูุฐุง)
        'ููุน_ุงูุนูุงุฑ'         # ุงูุชุตููู ุงูุจุฑูุฌู (ุงููุชูุฌุฉ ุงูููุงุฆูุฉ)
    ]
    
    # ุฅุนุงุฏุฉ ุชุณููุฉ ุงูุฃุนูุฏุฉ ููุนุฑุถ ุจุงูุนุฑุจู ุงููุงุถุญ
    rename_map = {
        'Source_File': 'ุงุณู ุงูููู',
        'ููุน_ุงูุนูุงุฑ_ุงูุฎุงู': '๐ ุชุตููู ุงูููู (ุงูุฃุตูู)',
        'ููุน_ุงูุนูุงุฑ': '๐ค ุงูุชุตููู ุงูุจุฑูุฌู (ุงููุนุงููุฌ)',
        'ุงููุณุงุญุฉ': 'ุงููุณุงุญุฉ (ูยฒ)'
    }
    
    st.dataframe(
        debug_df[cols_to_show].rename(columns=rename_map),
        use_container_width=True,
        height=600
    )

# ==========================================
# ุจููุฉ ุงูุชุทุจูู (ุงูุฏุงุดุจูุฑุฏ ูุงูุญุงุณุจุฉ) ููุง ูู
# ==========================================
elif app_mode == "๐ ุงูุฏุงุดุจูุฑุฏ":
    # (ููุณ ููุฏ ุงูุฏุงุดุจูุฑุฏ ุงูุณุงุจู ุงููุฎุชุตุฑ)
    if df.empty: st.stop()
    dist = st.sidebar.selectbox("ุงูุญู:", ["ุงููู"] + sorted(df['ุงูุญู'].unique()))
    v_df = df if dist == "ุงููู" else df[df['ุงูุญู'] == dist]
    st.dataframe(v_df[['Source_File', 'ุงูุญู', 'ุงูุณุนุฑ', 'ุงููุณุงุญุฉ', 'ููุน_ุงูุนูุงุฑ']], use_container_width=True)

elif app_mode == "๐๏ธ ุญุงุณุจุฉ ุงูุชูุงููู":
    # (ููุณ ููุฏ ุงูุญุงุณุจุฉ ุงูุณุงุจู)
    st.header("ุงูุญุงุณุจุฉ ุงูุนูุงุฑูุฉ")
    # ... (ููููู ูุณุฎ ููุฏ ุงูุญุงุณุจุฉ ููุง ุฅุฐุง ุฃุฑุฏุช ุงุณุชุฎุฏุงูู ูู ููุณ ุงูููุช)
